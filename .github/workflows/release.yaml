name: Release
# Release workflow builds the binaries for a release, and then publishes them to a newly created GitHub release.

on:
  release:
    types: [ created ]
  push:
    branches:
      - '**'
      - '!gh-pages'

jobs:
  build-linux:
    name: Create linux binary
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v2

      - name: Setup Flutter ğŸ§°
        uses: subosito/flutter-action@v1
        with:
          flutter-version: '2.2.2'

      - name: Build ğŸ­
        run: |
          sudo apt-get -y install clang cmake ninja-build pkg-config libgtk-3-dev
          flutter config --enable-linux-desktop
          make build-linux
      - name: Upload the artifacts ğŸ“¤
        uses: actions/upload-artifact@v2
        with:
          name: dam-linux-x64
          path: 'build/linux/x64/release/bundle/*'

  build-android:
    name: Create android apks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v2

      - name: Setup Flutter ğŸ§°
        uses: subosito/flutter-action@v1
        with:
          flutter-version: '2.2.2'

      - name: Build ğŸ­
        run: make build-android

      - name: Upload the artifacts ğŸ“¤
        uses: actions/upload-artifact@v2
        with:
          name: dam-android
          path: 'build/app/outputs/apk/release/*.apk'

  build-windows:
    name: Create windows binaries
    runs-on: windows-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v2

      - name: Setup Flutter ğŸ§°
        uses: subosito/flutter-action@v1
        with:
          flutter-version: '2.2.2'

      - name: Build ğŸ­
        run: |
          flutter config --enable-windows-desktop
          flutter build windows --release

      - name: Upload the artifacts ğŸ“¤
        uses: actions/upload-artifact@v2
        with:
          name: dam-windows-x64
          path: 'build/windows/runner/Release/*'

  build-macos:
    name: Create macos binaries
    runs-on: macos-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v2

      - name: Setup Flutter ğŸ§°
        uses: subosito/flutter-action@v1
        with:
          flutter-version: '2.2.2'

      - name: Build ğŸ­
        run: |
          flutter config --enable-macos-desktop
          flutter build macos --release
          cd build/macos/Build/Products/Release
          mkdir dam-macos-x64
          mv dam.app dam-macos-x64

      - name: Upload the artifacts ğŸ“¤
        uses: actions/upload-artifact@v2
        with:
          name: dam-macos-x64.app
          path: 'build/macos/Build/Products/Release/dam-macos-x64'

  build-ios:
    name: Create ios ipa
    runs-on: macos-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v2

      - name: Setup Flutter ğŸ§°
        uses: subosito/flutter-action@v1
        with:
          flutter-version: '2.2.2'

      - name: Build ğŸ­
        run: |
           flutter build ios --release --no-codesign
           cd build/ios/iphoneos
           mkdir Payload
           cd Payload
           ln -s ../Runner.app
           cd ..
           zip -r dam.ipa Payload

      - name: Upload the artifacts ğŸ“¤
        uses: actions/upload-artifact@v2
        with:
          name: dam-ios
          path: 'build/ios/iphoneos/dam.ipa'
